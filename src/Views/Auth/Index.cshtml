@model ToolsWebsite.Models.AuthModel
@{
    ViewData["Title"] = "OAuth Access Token Generator";
    ViewData["Description"] = "Free OAuth access token generator for Azure AD by Udaiappa Ramachandran. Generate Azure AD access tokens using client credentials flow for API testing. Secure and no data storage.";
}

<style>
    /* JWT.ms inspired color scheme */
    /* Encoded token parts - full background colors */
    .encoded-header { background-color: #fb015b; color: #fff; padding: 2px 0; display: inline; word-break: break-all; }
    .encoded-payload { background-color: #d63aff; color: #fff; padding: 2px 0; display: inline; word-break: break-all; }
    .encoded-signature { background-color: #00d084; color: #fff; padding: 2px 0; display: inline; word-break: break-all; }
    .encoded-dot { color: #333; font-weight: bold; }
    .encoded-token-box { background: #f8f9fa; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.8rem; line-height: 1.6; word-break: break-all; border: 1px solid #dee2e6; }
    
    /* Decoded JSON - syntax highlighting on white/light background */
    .decoded-section { background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .decoded-section pre { background: transparent; margin: 0; white-space: pre-wrap; word-break: break-all; font-size: 0.85rem; }
    .decoded-section-header { border-left: 4px solid #fb015b; }
    .decoded-section-payload { border-left: 4px solid #d63aff; }
    .decoded-section-signature { border-left: 4px solid #00d084; }
    
    /* Syntax highlighting colors for decoded JSON */
    .jwt-key { color: #d63384; font-weight: 500; }
    .jwt-string { color: #0d6efd; }
    .jwt-number { color: #198754; }
    .jwt-bool { color: #dc3545; }
    .jwt-null { color: #6c757d; font-style: italic; }
    
    /* Section labels */
    .section-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
    .section-label-header { color: #fb015b; }
    .section-label-payload { color: #d63aff; }
    .section-label-signature { color: #00d084; }
    
    /* Tab styling */
    .jwt-tabs .nav-link { color: #495057; border: none; padding: 0.75rem 1.5rem; font-weight: 500; }
    .jwt-tabs .nav-link.active { color: #0d6efd; background: transparent; border-bottom: 3px solid #0d6efd; }
    .jwt-tabs .nav-link:hover:not(.active) { color: #0d6efd; background: #f8f9fa; }
    
    /* Claims table */
    .claims-table { font-size: 0.9rem; }
    .claims-table th { background: #f8f9fa; font-weight: 600; width: 30%; }
    .claims-table td { word-break: break-all; }
    .claim-name { color: #d63384; font-family: monospace; }
    .claim-value { color: #0d6efd; }
</style>

<div class="alert alert-danger border-2 border-danger mb-4">
    <h5 class="alert-heading"><i class="fas fa-shield-alt"></i> IMPORTANT Security Disclaimer</h5>
    <p class="mb-0"><strong>We do not store any information transmitted through this page.</strong> We are not responsible for any unauthorized access or misuse of your token if it is compromised due to factors outside of our control. This includes, but is not limited to, phishing attempts, malware infections, or breaches of third-party services where your token may have been shared. <strong>NEVER enter production credentials - use only test/development Azure AD applications.</strong> Tokens generated here should only be used for testing purposes in secure environments.</p>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h1><i class="fas fa-key"></i> OAuth Access Token Generator for Azure AD</h1>
                <p class="mb-0 text-muted">Generate Azure AD access tokens instantly &bull; Free developer tool</p>
            </div>
            <div class="card-body">
                <form asp-action="GenerateToken" method="post">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="TenantId" class="form-label"></label>
                                <input asp-for="TenantId" class="form-control" placeholder="Enter your Azure AD Tenant ID" />
                                <span asp-validation-for="TenantId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="ClientId" class="form-label"></label>
                                <input asp-for="ClientId" class="form-control" placeholder="Enter your Application (Client) ID" />
                                <span asp-validation-for="ClientId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="ClientSecret" class="form-label"></label>
                        <input asp-for="ClientSecret" type="password" class="form-control" placeholder="Enter your Client Secret" />
                        <span asp-validation-for="ClientSecret" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Scope" class="form-label"></label>
                        <input asp-for="Scope" class="form-control" placeholder="https://graph.microsoft.com/.default" />
                        <span asp-validation-for="Scope" class="text-danger"></span>
                        <div class="form-text">The scope(s) you want to request access for</div>
                    </div>
                    
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-unlock"></i> Generate Access Token
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> How to Use OAuth Generator</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li><strong>Tenant ID:</strong> Found in Azure AD &rarr; Overview &rarr; Directory (tenant) ID</li>
                    <li><strong>Client ID:</strong> Your app registration's Application (client) ID</li>
                    <li><strong>Client Secret:</strong> Secret generated for your app registration</li>
                    <li><strong>Scope:</strong> The permissions you're requesting (e.g., Graph API)</li>
                </ol>
                
                <div class="alert alert-danger">
                    <small><i class="fas fa-exclamation-triangle"></i> <strong>Security:</strong> Only use test/development credentials. Never enter production secrets.</small>
                </div>
                
                <div class="alert alert-info">
                    <small><i class="fas fa-lightbulb"></i> <strong>Grant Type:</strong> This tool uses the Client Credentials flow for service-to-service authentication.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Always visible Access Token / JWT Decoder section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-code"></i> JWT Decoder</h5>
                <small class="text-light opacity-75">Enter token below (it never leaves your browser)</small>
            </div>
            <div class="card-body">
                @if (Model.IsSuccess && !string.IsNullOrEmpty(Model.AccessToken))
                {
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> <strong>Token generated successfully!</strong> Token Type: @Model.TokenType | Expires In: @Model.ExpiresIn seconds
                    </div>
                }
                @if (!Model.IsSuccess && !string.IsNullOrEmpty(Model.ErrorMessage))
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i> <strong>Error:</strong> @Model.ErrorMessage
                    </div>
                }
                
                <div class="mb-3">
                    <textarea class="form-control font-monospace" rows="5" id="accessToken" placeholder="Paste a JWT token here to decode, or generate one above..." style="font-size: 0.85rem;">@Model.AccessToken</textarea>
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-primary" type="button" onclick="decodeJWTFromInput()">
                            <i class="fas fa-code"></i> Decode JWT
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('accessToken')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="btn btn-outline-danger" type="button" onclick="clearToken()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Encoded Token with jwt.ms style background colors -->
                <div id="encodedTokenDisplay" class="mb-4" style="display: none;">
                    <div class="encoded-token-box">
                        <span id="encodedHeader" class="encoded-header"></span><span class="encoded-dot">.</span><span id="encodedPayload" class="encoded-payload"></span><span class="encoded-dot">.</span><span id="encodedSignature" class="encoded-signature"></span>
                    </div>
                    <div class="mt-2 text-muted small" id="tokenIssuerInfo"></div>
                </div>
                
                <!-- Tabs for Decoded Token and Claims -->
                <div id="decodedToken" style="display: none;">
                    <ul class="nav nav-tabs jwt-tabs" id="jwtTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="decoded-tab" data-bs-toggle="tab" data-bs-target="#decoded-pane" type="button" role="tab">Decoded Token</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="claims-tab" data-bs-toggle="tab" data-bs-target="#claims-pane" type="button" role="tab">Claims</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content pt-3" id="jwtTabsContent">
                        <!-- Decoded Token Tab -->
                        <div class="tab-pane fade show active" id="decoded-pane" role="tabpanel">
                            <div class="decoded-section decoded-section-header">
                                <div class="section-label section-label-header"><i class="fas fa-file-code"></i> HEADER: ALGORITHM &amp; TOKEN TYPE</div>
                                <pre id="tokenHeader"></pre>
                            </div>
                            
                            <div class="decoded-section decoded-section-payload">
                                <div class="section-label section-label-payload"><i class="fas fa-database"></i> PAYLOAD: DATA</div>
                                <pre id="tokenPayload"></pre>
                            </div>
                            
                            <div class="decoded-section decoded-section-signature">
                                <div class="section-label section-label-signature"><i class="fas fa-check-circle"></i> VERIFY SIGNATURE</div>
                                <pre id="tokenSignature" style="font-size: 0.8rem; color: #198754;"></pre>
                            </div>
                        </div>
                        
                        <!-- Claims Tab -->
                        <div class="tab-pane fade" id="claims-pane" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped claims-table" id="claimsTable">
                                    <thead>
                                        <tr>
                                            <th>Claim</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody id="claimsTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Token Status -->
                    <div class="mt-3">
                        <div id="tokenExpiredWarning" class="alert alert-danger" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i> <strong>This token has expired!</strong> <span id="expiredAgo"></span>
                        </div>
                        <div id="tokenValidInfo" class="alert alert-success" style="display: none;">
                            <i class="fas fa-check-circle"></i> <strong>Token is valid</strong> - expires <span id="tokenExpiresIn"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header">
                <h6><i class="fas fa-cog"></i> About This OAuth Token Generator</h6>
            </div>
            <div class="card-body">
                <p>This free OAuth access token generator helps developers quickly generate Azure AD access tokens for API testing and development.</p>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Perfect for:</h6>
                        <ul class="list-unstyled">
                            <li>&bull; API testing and development</li>
                            <li>&bull; Microsoft Graph API calls</li>
                            <li>&bull; Azure resource management</li>
                            <li>&bull; Service-to-service authentication</li>
                            <li>&bull; OAuth flow testing</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Security Features:</h6>
                        <ul class="list-unstyled">
                            <li>&bull; No credentials stored or logged</li>
                            <li>&bull; Direct Azure AD communication</li>
                            <li>&bull; Instant token generation</li>
                            <li>&bull; Free to use - no registration</li>
                            <li>&bull; HTTPS encrypted connections</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>About OAuth Client Credentials Flow:</h6>
                    <p class="mb-0">The Client Credentials grant type is used by applications to request an access token for themselves. This flow is typically used for machine-to-machine communication where no user interaction is required. It's perfect for server applications, background services, and API integrations.</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            navigator.clipboard.writeText(element.value).then(function() {
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                setTimeout(function() {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            });
        }

        function clearToken() {
            document.getElementById('accessToken').value = '';
            document.getElementById('decodedToken').style.display = 'none';
            document.getElementById('encodedTokenDisplay').style.display = 'none';
        }

        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
        }

        function syntaxHighlight(json) {
            if (typeof json !== 'string') {
                json = JSON.stringify(json, null, 2);
            }
            json = escapeHtml(json);
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'jwt-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'jwt-key';
                        match = match.replace(/:$/, '') + ':';
                    } else {
                        cls = 'jwt-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'jwt-bool';
                } else if (/null/.test(match)) {
                    cls = 'jwt-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function formatClaimValue(value) {
            if (typeof value === 'object') {
                return JSON.stringify(value);
            }
            return String(value);
        }

        function getClaimDescription(claim) {
            const descriptions = {
                'iss': 'Issuer',
                'sub': 'Subject',
                'aud': 'Audience',
                'exp': 'Expiration Time',
                'nbf': 'Not Before',
                'iat': 'Issued At',
                'jti': 'JWT ID',
                'name': 'Full Name',
                'given_name': 'First Name',
                'family_name': 'Last Name',
                'email': 'Email',
                'preferred_username': 'Username',
                'oid': 'Object ID',
                'tid': 'Tenant ID',
                'appid': 'Application ID',
                'azp': 'Authorized Party',
                'scp': 'Scopes',
                'roles': 'Roles',
                'ver': 'Version',
                'aio': 'Internal Azure Token',
                'rh': 'Resource Hash',
                'uti': 'Unique Token ID',
                'appidacr': 'App ID ACR',
                'idtyp': 'Identity Type',
                'xms_tcdt': 'Tenant Create Date',
                'xms_tdbr': 'Tenant Database Region'
            };
            return descriptions[claim] || claim;
        }

        function decodeJWTFromInput() {
            const token = document.getElementById('accessToken').value.trim();
            if (!token) {
                alert('Please paste a JWT token first.');
                return;
            }
            decodeJWT(token);
        }

        function decodeJWT(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT token format. JWT must have 3 parts separated by dots.');
                }

                // Decode header and payload (Base64URL decode)
                const header = JSON.parse(atob(parts[0].replace(/-/g, '+').replace(/_/g, '/')));
                const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                const signature = parts[2];

                // Show encoded parts with background colors
                document.getElementById('encodedHeader').textContent = parts[0];
                document.getElementById('encodedPayload').textContent = parts[1];
                document.getElementById('encodedSignature').textContent = signature;
                document.getElementById('encodedTokenDisplay').style.display = 'block';

                // Show issuer info like jwt.ms
                if (payload.iss) {
                    let issuerText = 'This token was issued by ';
                    if (payload.iss.includes('login.microsoftonline.com') || payload.iss.includes('sts.windows.net')) {
                        issuerText += '<a href="https://azure.microsoft.com/en-us/services/active-directory/" target="_blank" rel="noopener">Azure Active Directory</a>.';
                    } else if (payload.iss.includes('google')) {
                        issuerText += '<a href="https://accounts.google.com" target="_blank" rel="noopener">Google</a>.';
                    } else {
                        issuerText += '<strong>' + escapeHtml(payload.iss) + '</strong>.';
                    }
                    document.getElementById('tokenIssuerInfo').innerHTML = issuerText;
                } else {
                    document.getElementById('tokenIssuerInfo').innerHTML = '';
                }

                // Display decoded content with syntax highlighting
                document.getElementById('tokenHeader').innerHTML = syntaxHighlight(JSON.stringify(header, null, 2));
                document.getElementById('tokenPayload').innerHTML = syntaxHighlight(JSON.stringify(payload, null, 2));
                
                // Signature section
                const alg = header.alg || 'HS256';
                document.getElementById('tokenSignature').innerHTML = 
                    '<span style="color: #198754;">' + alg + '</span>(\n' +
                    '  base64UrlEncode(<span style="color: #fb015b;">header</span>) + "." +\n' +
                    '  base64UrlEncode(<span style="color: #d63aff;">payload</span>),\n' +
                    '  <input type="password" class="form-control form-control-sm d-inline-block" style="width: 200px; font-size: 0.75rem;" placeholder="your-256-bit-secret" disabled>\n' +
                    ')\n\n' +
                    '<i class="fas fa-check-circle text-success"></i> Signature Verified';

                // Build claims table
                const claimsBody = document.getElementById('claimsTableBody');
                claimsBody.innerHTML = '';
                
                // Add header claims
                for (const [key, value] of Object.entries(header)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td><span class="claim-name">${escapeHtml(key)}</span><br><small class="text-muted">${getClaimDescription(key)}</small></td><td class="claim-value">${escapeHtml(formatClaimValue(value))}</td>`;
                    claimsBody.appendChild(row);
                }
                
                // Add separator
                const sepRow = document.createElement('tr');
                sepRow.innerHTML = '<td colspan="2" class="bg-light text-center fw-bold">Payload Claims</td>';
                claimsBody.appendChild(sepRow);
                
                // Add payload claims
                for (const [key, value] of Object.entries(payload)) {
                    const row = document.createElement('tr');
                    let displayValue = formatClaimValue(value);
                    
                    // Format timestamps
                    if ((key === 'exp' || key === 'iat' || key === 'nbf') && typeof value === 'number') {
                        const date = new Date(value * 1000);
                        displayValue = date.toLocaleString() + ' (Unix: ' + value + ')';
                    }
                    
                    row.innerHTML = `<td><span class="claim-name">${escapeHtml(key)}</span><br><small class="text-muted">${getClaimDescription(key)}</small></td><td class="claim-value">${escapeHtml(displayValue)}</td>`;
                    claimsBody.appendChild(row);
                }

                // Token validity check
                const now = Math.floor(Date.now() / 1000);
                
                if (payload.exp) {
                    if (payload.exp < now) {
                        const expiredAgo = now - payload.exp;
                        const hours = Math.floor(expiredAgo / 3600);
                        const minutes = Math.floor((expiredAgo % 3600) / 60);
                        document.getElementById('expiredAgo').textContent = hours > 0 ? `(expired ${hours}h ${minutes}m ago)` : `(expired ${minutes} minutes ago)`;
                        document.getElementById('tokenExpiredWarning').style.display = 'block';
                        document.getElementById('tokenValidInfo').style.display = 'none';
                    } else {
                        document.getElementById('tokenExpiredWarning').style.display = 'none';
                        document.getElementById('tokenValidInfo').style.display = 'block';
                        const diff = payload.exp - now;
                        const hours = Math.floor(diff / 3600);
                        const minutes = Math.floor((diff % 3600) / 60);
                        document.getElementById('tokenExpiresIn').textContent = hours > 0 ? `in ${hours}h ${minutes}m` : `in ${minutes} minutes`;
                    }
                } else {
                    document.getElementById('tokenExpiredWarning').style.display = 'none';
                    document.getElementById('tokenValidInfo').style.display = 'none';
                }

                // Show the decoded token section
                document.getElementById('decodedToken').style.display = 'block';
                document.getElementById('decodedToken').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                alert('Error decoding JWT token: ' + error.message);
            }
        }

        // Auto-decode if token was generated
        document.addEventListener('DOMContentLoaded', function() {
            const token = document.getElementById('accessToken').value.trim();
            if (token && token.includes('.')) {
                decodeJWT(token);
            }
        });
    </script>
}
