@model ToolsWebsite.Models.AuthModel
@{
    ViewData["Title"] = "OAuth Access Token Generator";
    ViewData["Description"] = "Free OAuth access token generator for Azure AD by Udaiappa Ramachandran. Generate Azure AD access tokens using client credentials flow for API testing. Secure and no data storage.";
}

<style>
    /* JWT.ms inspired color scheme */
    .jwt-header { background: linear-gradient(135deg, #fb015b 0%, #d6336c 100%); color: #fff; }
    .jwt-payload { background: linear-gradient(135deg, #d63aff 0%, #7c3aed 100%); color: #fff; }
    .jwt-signature { background: linear-gradient(135deg, #00b9f1 0%, #0284c7 100%); color: #fff; }
    .jwt-section { border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .jwt-section pre { background: rgba(255,255,255,0.15); color: #fff; border: none; margin: 0; white-space: pre-wrap; word-break: break-all; }
    .jwt-section h6 { color: #fff; margin-bottom: 0.75rem; }
    .jwt-key { color: #ffd700; }
    .jwt-string { color: #98fb98; }
    .jwt-number { color: #87ceeb; }
    .jwt-bool { color: #ffa07a; }
    .jwt-null { color: #d3d3d3; font-style: italic; }
    .token-part { padding: 4px 8px; border-radius: 4px; font-family: monospace; word-break: break-all; }
    .token-part-header { background-color: #fb015b; color: #fff; }
    .token-part-payload { background-color: #d63aff; color: #fff; }
    .token-part-signature { background-color: #00b9f1; color: #fff; }
    .token-dot { color: #666; font-weight: bold; padding: 0 2px; }
</style>

<div class="alert alert-danger border-2 border-danger mb-4">
    <h5 class="alert-heading"><i class="fas fa-shield-alt"></i> IMPORTANT Security Disclaimer</h5>
    <p class="mb-0"><strong>We do not store any information transmitted through this page.</strong> We are not responsible for any unauthorized access or misuse of your token if it is compromised due to factors outside of our control. This includes, but is not limited to, phishing attempts, malware infections, or breaches of third-party services where your token may have been shared. <strong>NEVER enter production credentials - use only test/development Azure AD applications.</strong> Tokens generated here should only be used for testing purposes in secure environments.</p>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h1><i class="fas fa-key"></i> OAuth Access Token Generator for Azure AD</h1>
                <p class="mb-0 text-muted">Generate Azure AD access tokens instantly &bull; Free developer tool</p>
            </div>
            <div class="card-body">
                <form asp-action="GenerateToken" method="post">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="TenantId" class="form-label"></label>
                                <input asp-for="TenantId" class="form-control" placeholder="Enter your Azure AD Tenant ID" />
                                <span asp-validation-for="TenantId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="ClientId" class="form-label"></label>
                                <input asp-for="ClientId" class="form-control" placeholder="Enter your Application (Client) ID" />
                                <span asp-validation-for="ClientId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="ClientSecret" class="form-label"></label>
                        <input asp-for="ClientSecret" type="password" class="form-control" placeholder="Enter your Client Secret" />
                        <span asp-validation-for="ClientSecret" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Scope" class="form-label"></label>
                        <input asp-for="Scope" class="form-control" placeholder="https://graph.microsoft.com/.default" />
                        <span asp-validation-for="Scope" class="text-danger"></span>
                        <div class="form-text">The scope(s) you want to request access for</div>
                    </div>
                    
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-unlock"></i> Generate Access Token
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> How to Use OAuth Generator</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li><strong>Tenant ID:</strong> Found in Azure AD &rarr; Overview &rarr; Directory (tenant) ID</li>
                    <li><strong>Client ID:</strong> Your app registration's Application (client) ID</li>
                    <li><strong>Client Secret:</strong> Secret generated for your app registration</li>
                    <li><strong>Scope:</strong> The permissions you're requesting (e.g., Graph API)</li>
                </ol>
                
                <div class="alert alert-danger">
                    <small><i class="fas fa-exclamation-triangle"></i> <strong>Security:</strong> Only use test/development credentials. Never enter production secrets.</small>
                </div>
                
                <div class="alert alert-info">
                    <small><i class="fas fa-lightbulb"></i> <strong>Grant Type:</strong> This tool uses the Client Credentials flow for service-to-service authentication.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Always visible Access Token / JWT Decoder section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-code"></i> Access Token / JWT Decoder</h5>
            </div>
            <div class="card-body">
                @if (Model.IsSuccess && !string.IsNullOrEmpty(Model.AccessToken))
                {
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> <strong>Token generated successfully!</strong> Token Type: @Model.TokenType | Expires In: @Model.ExpiresIn seconds
                    </div>
                }
                @if (!Model.IsSuccess && !string.IsNullOrEmpty(Model.ErrorMessage))
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i> <strong>Error:</strong> @Model.ErrorMessage
                    </div>
                }
                
                <div class="mb-3">
                    <label class="form-label"><strong>Access Token (paste any JWT to decode):</strong></label>
                    <div class="input-group">
                        <textarea class="form-control" rows="4" id="accessToken" placeholder="Paste a JWT token here to decode, or generate one above...">@Model.AccessToken</textarea>
                    </div>
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-primary" type="button" onclick="decodeJWTFromInput()">
                            <i class="fas fa-code"></i> Decode JWT
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('accessToken')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="btn btn-outline-danger" type="button" onclick="clearToken()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Encoded Token with color parts -->
                <div id="encodedTokenDisplay" class="mb-4" style="display: none;">
                    <h6><i class="fas fa-puzzle-piece"></i> Encoded Token</h6>
                    <div class="p-3 bg-dark rounded" style="font-size: 0.75rem; line-height: 1.5;">
                        <span id="encodedHeader" class="token-part token-part-header"></span><span class="token-dot">.</span><span id="encodedPayload" class="token-part token-part-payload"></span><span class="token-dot">.</span><span id="encodedSignature" class="token-part token-part-signature"></span>
                    </div>
                </div>
                
                <!-- JWT Decoded Content -->
                <div id="decodedToken" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="jwt-section jwt-header">
                                <h6><i class="fas fa-file-code"></i> HEADER: ALGORITHM &amp; TOKEN TYPE</h6>
                                <pre id="tokenHeader"></pre>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="jwt-section jwt-payload">
                                <h6><i class="fas fa-database"></i> PAYLOAD: DATA</h6>
                                <pre id="tokenPayload"></pre>
                            </div>
                        </div>
                    </div>
                    
                    <div class="jwt-section jwt-signature">
                        <h6><i class="fas fa-shield-alt"></i> VERIFY SIGNATURE</h6>
                        <pre id="tokenSignature" style="font-size: 0.7rem;"></pre>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-info-circle"></i> Token Claims Summary</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-2">
                                    <strong>Algorithm:</strong> <span id="tokenAlgorithm" class="badge bg-secondary">-</span>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <strong>Issued At:</strong> <span id="tokenIssuedAt">-</span>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <strong>Expires At:</strong> <span id="tokenExpiresAt">-</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-2">
                                    <strong>Issuer:</strong> <span id="tokenIssuer" class="text-break" style="font-size: 0.85rem;">-</span>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <strong>Audience:</strong> <span id="tokenAudience" class="text-break" style="font-size: 0.85rem;">-</span>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <strong>Subject:</strong> <span id="tokenSubject" class="text-break" style="font-size: 0.85rem;">-</span>
                                </div>
                            </div>
                            <div id="tokenExpiredWarning" class="alert alert-danger mt-2" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i> <strong>This token has expired!</strong>
                            </div>
                            <div id="tokenValidInfo" class="alert alert-success mt-2" style="display: none;">
                                <i class="fas fa-check-circle"></i> <strong>Token is valid</strong> - expires <span id="tokenExpiresIn"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header">
                <h6><i class="fas fa-cog"></i> About This OAuth Token Generator</h6>
            </div>
            <div class="card-body">
                <p>This free OAuth access token generator helps developers quickly generate Azure AD access tokens for API testing and development.</p>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Perfect for:</h6>
                        <ul class="list-unstyled">
                            <li>&bull; API testing and development</li>
                            <li>&bull; Microsoft Graph API calls</li>
                            <li>&bull; Azure resource management</li>
                            <li>&bull; Service-to-service authentication</li>
                            <li>&bull; OAuth flow testing</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Security Features:</h6>
                        <ul class="list-unstyled">
                            <li>&bull; No credentials stored or logged</li>
                            <li>&bull; Direct Azure AD communication</li>
                            <li>&bull; Instant token generation</li>
                            <li>&bull; Free to use - no registration</li>
                            <li>&bull; HTTPS encrypted connections</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>About OAuth Client Credentials Flow:</h6>
                    <p class="mb-0">The Client Credentials grant type is used by applications to request an access token for themselves. This flow is typically used for machine-to-machine communication where no user interaction is required. It's perfect for server applications, background services, and API integrations.</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            navigator.clipboard.writeText(element.value).then(function() {
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                setTimeout(function() {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            });
        }

        function clearToken() {
            document.getElementById('accessToken').value = '';
            document.getElementById('decodedToken').style.display = 'none';
            document.getElementById('encodedTokenDisplay').style.display = 'none';
        }

        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
        }

        function syntaxHighlight(json) {
            if (typeof json !== 'string') {
                json = JSON.stringify(json, null, 2);
            }
            json = escapeHtml(json);
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'jwt-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'jwt-key';
                        match = match.replace(/:$/, '') + ':';
                    } else {
                        cls = 'jwt-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'jwt-bool';
                } else if (/null/.test(match)) {
                    cls = 'jwt-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function decodeJWTFromInput() {
            const token = document.getElementById('accessToken').value.trim();
            if (!token) {
                alert('Please paste a JWT token first.');
                return;
            }
            decodeJWT(token);
        }

        function decodeJWT(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT token format. JWT must have 3 parts separated by dots.');
                }

                // Decode header and payload (Base64URL decode)
                const header = JSON.parse(atob(parts[0].replace(/-/g, '+').replace(/_/g, '/')));
                const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                const signature = parts[2];

                // Show encoded parts with colors
                document.getElementById('encodedHeader').textContent = parts[0];
                document.getElementById('encodedPayload').textContent = parts[1];
                document.getElementById('encodedSignature').textContent = signature;
                document.getElementById('encodedTokenDisplay').style.display = 'block';

                // Display decoded content with syntax highlighting
                document.getElementById('tokenHeader').innerHTML = syntaxHighlight(JSON.stringify(header, null, 2));
                document.getElementById('tokenPayload').innerHTML = syntaxHighlight(JSON.stringify(payload, null, 2));
                document.getElementById('tokenSignature').textContent = 'HMACSHA256(\n  base64UrlEncode(header) + "." +\n  base64UrlEncode(payload),\n  your-256-bit-secret\n)\n\nSignature: ' + signature;

                // Extract and display common claims
                document.getElementById('tokenAlgorithm').textContent = header.alg || '-';
                document.getElementById('tokenIssuer').textContent = payload.iss || '-';
                document.getElementById('tokenAudience').textContent = payload.aud || '-';
                document.getElementById('tokenSubject').textContent = payload.sub || payload.appid || payload.azp || '-';

                // Convert timestamps to readable dates
                const now = Math.floor(Date.now() / 1000);
                
                if (payload.iat) {
                    const issuedAt = new Date(payload.iat * 1000);
                    document.getElementById('tokenIssuedAt').textContent = issuedAt.toLocaleString();
                } else {
                    document.getElementById('tokenIssuedAt').textContent = '-';
                }

                if (payload.exp) {
                    const expiresAt = new Date(payload.exp * 1000);
                    document.getElementById('tokenExpiresAt').textContent = expiresAt.toLocaleString();
                    
                    // Check if expired
                    if (payload.exp < now) {
                        document.getElementById('tokenExpiredWarning').style.display = 'block';
                        document.getElementById('tokenValidInfo').style.display = 'none';
                    } else {
                        document.getElementById('tokenExpiredWarning').style.display = 'none';
                        document.getElementById('tokenValidInfo').style.display = 'block';
                        const diff = payload.exp - now;
                        const hours = Math.floor(diff / 3600);
                        const minutes = Math.floor((diff % 3600) / 60);
                        document.getElementById('tokenExpiresIn').textContent = hours > 0 ? `in ${hours}h ${minutes}m` : `in ${minutes} minutes`;
                    }
                } else {
                    document.getElementById('tokenExpiresAt').textContent = '-';
                    document.getElementById('tokenExpiredWarning').style.display = 'none';
                    document.getElementById('tokenValidInfo').style.display = 'none';
                }

                // Show the decoded token section
                document.getElementById('decodedToken').style.display = 'block';
                document.getElementById('decodedToken').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                alert('Error decoding JWT token: ' + error.message);
            }
        }

        // Auto-decode if token was generated
        document.addEventListener('DOMContentLoaded', function() {
            const token = document.getElementById('accessToken').value.trim();
            if (token && token.includes('.')) {
                decodeJWT(token);
            }
        });
    </script>
}